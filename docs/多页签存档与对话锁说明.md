# 多页签存档与对话锁说明

# 目标
1. 多个页签共享同一份 `chat_history`。
2. 每个页签单独维护自己的 `current_chat_id`。
3. 同一时刻一个对话只允许一个页签占用。

# 存储结构
1. 聊天历史存放在 IndexedDB 的 `chat_history`。
2. 当前对话按页签存放在 IndexedDB 的 `current_chat_id:{tabId}`。
3. 对话锁存放在 `localStorage` 的 `bs2_chat_locks_v1`。

# 页签 ID
1. 每个页签首次加载时通过 `sessionStorage` 分配一个 UUID。
2. 刷新页签保持同一个 ID（sessionStorage 的特性）。
3. 复制页签（浏览器 duplicate tab）会得到相同 sessionStorage，即相同 tabId，这与"新开一个页签"不同。

# 对话锁规则
1. 页签切换到某个对话前先尝试获取该对话锁。
2. 如果锁属于其他页签且未过期，当前页签不切换并弹出提示。
3. 切换成功后释放旧对话锁。
4. 页签关闭或销毁时同步释放该页签持有的全部对话锁。
5. 锁有心跳（10 秒续期）与 TTL（30 秒过期），避免异常关闭导致长期占用。
6. BFCache 恢复时通过 `pageshow` 事件重新初始化锁运行时。

# 存档写入规则
1. 写入前先读取最新 `chat_history`。
2. 以内存数据与存储数据按对话 ID 合并后再写回。
3. 同一对话内按消息 ID 合并消息，取内容更长或更新的版本。
4. 删除操作通过 `_pendingDeletedChatIds` 集合传递给合并函数，确保被删对话不会被合并复活。

# 已修改文件
1. `src/utils/chatStorage.js`
2. `src/utils/chatLock.js`
3. `src/appCore/methods/chatMethods.js`
4. `src/AppCore.vue`
