# 插件开发示例

本文档通过具体示例，展示如何开发新的模式插件和工具插件。

## 示例1：虚拟恋人模式

### 功能描述

- 与AI建立虚拟恋爱关系
- 好感度系统（随对话变化）
- 送礼系统（影响好感度）
- 特殊事件触发（约会、纪念日等）

### 实现步骤

#### 1. 创建插件目录

```
src/modes/VirtualLoverMode/
├── index.vue                    # 主组件
├── plugin.js                    # 插件配置
├── components/
│   ├── FavorabilityPanel.vue    # 好感度面板
│   └── GiftSelector.vue         # 礼物选择器
└── utils/
    └── favorabilityCalculator.js  # 好感度计算逻辑
```

#### 2. 实现好感度计算逻辑

```javascript
// src/modes/VirtualLoverMode/utils/favorabilityCalculator.js

/**
 * 根据AI回复内容分析情感倾向
 * @param {string} content - AI回复内容
 * @returns {number} 好感度变化值 (-10 到 +10)
 */
export function analyzeSentiment(content) {
  // 正面词汇
  const positiveWords = ['喜欢', '开心', '谢谢', '爱', '想你', '甜蜜'];
  // 负面词汇
  const negativeWords = ['讨厌', '烦', '生气', '失望', '难过'];
  
  let score = 0;
  
  positiveWords.forEach(word => {
    if (content.includes(word)) score += 2;
  });
  
  negativeWords.forEach(word => {
    if (content.includes(word)) score -= 2;
  });
  
  // 限制在 -10 到 +10 范围内
  return Math.max(-10, Math.min(10, score));
}

/**
 * 计算送礼带来的好感度变化
 */
export function calculateGiftEffect(giftType) {
  const giftEffects = {
    'flower': 5,
    'chocolate': 8,
    'jewelry': 15,
    'letter': 10
  };
  
  return giftEffects[giftType] || 0;
}
```

#### 3. 实现好感度面板组件

```vue
<!-- src/modes/VirtualLoverMode/components/FavorabilityPanel.vue -->
<template>
  <div class="favorability-panel p-4 bg-gradient-to-br from-pink-100 to-purple-100 rounded-lg shadow-md">
    <h3 class="text-lg font-bold text-gray-800 mb-2">关系状态</h3>
    
    <!-- 好感度条 -->
    <div class="favorability-bar mb-4">
      <div class="flex justify-between text-sm text-gray-600 mb-1">
        <span>好感度</span>
        <span>{{ favorability }}%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
        <div 
          class="h-full transition-all duration-500"
          :class="favorabilityColorClass"
          :style="{ width: favorability + '%' }"
        ></div>
      </div>
      <div class="text-center text-sm font-semibold mt-1" :class="relationshipLevelColor">
        {{ relationshipLevel }}
      </div>
    </div>
    
    <!-- 统计信息 -->
    <div class="stats grid grid-cols-2 gap-2 text-sm">
      <div class="stat-item bg-white p-2 rounded">
        <div class="text-gray-500">对话次数</div>
        <div class="text-lg font-bold">{{ chatCount }}</div>
      </div>
      <div class="stat-item bg-white p-2 rounded">
        <div class="text-gray-500">相识天数</div>
        <div class="text-lg font-bold">{{ daysSinceMeet }}</div>
      </div>
    </div>
    
    <!-- 送礼按钮 -->
    <el-button 
      class="w-full mt-4" 
      type="primary"
      @click="$emit('open-gift-selector')"
    >
      <el-icon class="mr-1"><Present /></el-icon>
      送礼物
    </el-button>
  </div>
</template>

<script>
import { Present } from '@element-plus/icons-vue';

export default {
  name: 'FavorabilityPanel',
  components: { Present },
  props: {
    favorability: {
      type: Number,
      default: 50
    },
    chatCount: {
      type: Number,
      default: 0
    },
    createdAt: {
      type: String,
      default: ''
    }
  },
  emits: ['open-gift-selector'],
  computed: {
    favorabilityColorClass() {
      if (this.favorability < 30) return 'bg-gray-400';
      if (this.favorability < 50) return 'bg-blue-400';
      if (this.favorability < 70) return 'bg-green-400';
      if (this.favorability < 90) return 'bg-pink-400';
      return 'bg-red-400';
    },
    relationshipLevel() {
      if (this.favorability < 30) return '陌生人';
      if (this.favorability < 50) return '普通朋友';
      if (this.favorability < 70) return '好朋友';
      if (this.favorability < 90) return '亲密';
      return '爱人';
    },
    relationshipLevelColor() {
      if (this.favorability < 30) return 'text-gray-600';
      if (this.favorability < 50) return 'text-blue-600';
      if (this.favorability < 70) return 'text-green-600';
      if (this.favorability < 90) return 'text-pink-600';
      return 'text-red-600';
    },
    daysSinceMeet() {
      if (!this.createdAt) return 0;
      const created = new Date(this.createdAt);
      const now = new Date();
      const diffTime = Math.abs(now - created);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return diffDays;
    }
  }
};
</script>

<style scoped>
.favorability-bar {
  animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
```

#### 4. 实现主插件组件

```vue
<!-- src/modes/VirtualLoverMode/index.vue -->
<template>
  <div class="virtual-lover-mode flex h-full">
    <!-- 左侧：对话区 -->
    <div class="chat-area flex-1 flex flex-col">
      <el-main class="flex-1 overflow-y-auto p-5">
        <!-- 空状态 -->
        <EmptyState
          v-if="!messages.length"
          title="开始你的浪漫故事"
          description="和AI开始一段独特的虚拟恋爱关系"
        >
          <template #actions>
            <el-button type="primary" @click="startConversation">
              开始对话
            </el-button>
          </template>
        </EmptyState>
        
        <!-- 消息列表 -->
        <MessageBubble
          v-for="(msg, index) in messages"
          :key="index"
          :role="msg.role"
          :content="msg.content"
        >
          <template #controls="{ message }">
            <div class="flex gap-2">
              <el-tooltip content="复制" placement="top">
                <el-button size="small" @click="$emit('copy-message', message.content)">
                  <el-icon><CopyDocument /></el-icon>
                </el-button>
              </el-tooltip>
            </div>
          </template>
        </MessageBubble>
        
        <!-- 好感度变化提示 -->
        <transition name="fade">
          <div v-if="showFavorabilityChange" class="favorability-change-toast">
            好感度 {{ favorabilityChange > 0 ? '+' : '' }}{{ favorabilityChange }}
          </div>
        </transition>
      </el-main>
      
      <!-- 输入区 -->
      <ChatInput
        v-model="inputMessage"
        :disabled="isLoading"
        :is-loading="isLoading"
        placeholder="说点什么让TA开心吧..."
        @send="handleSend"
        @cancel="handleCancel"
        ref="inputRef"
      />
    </div>
    
    <!-- 右侧：状态面板 -->
    <div class="status-panel w-80 border-l border-gray-200 p-4 overflow-y-auto">
      <FavorabilityPanel
        :favorability="loverData.favorability"
        :chat-count="messages.length / 2"
        :created-at="loverData.createdAt"
        @open-gift-selector="showGiftSelector = true"
      />
      
      <!-- 特殊事件提醒 -->
      <div v-if="specialEvents.length" class="special-events mt-4">
        <h4 class="font-bold mb-2">特殊事件</h4>
        <div 
          v-for="event in specialEvents" 
          :key="event.id"
          class="event-item p-2 bg-yellow-50 rounded mb-2"
        >
          {{ event.message }}
        </div>
      </div>
    </div>
    
    <!-- 礼物选择器对话框 -->
    <el-dialog v-model="showGiftSelector" title="选择礼物">
      <div class="gifts grid grid-cols-2 gap-4">
        <div 
          v-for="gift in gifts" 
          :key="gift.id"
          class="gift-card p-4 border rounded cursor-pointer hover:border-pink-400 transition"
          @click="selectGift(gift)"
        >
          <div class="text-4xl text-center mb-2">{{ gift.emoji }}</div>
          <div class="text-center font-semibold">{{ gift.name }}</div>
          <div class="text-center text-sm text-gray-500">好感度 +{{ gift.effect }}</div>
        </div>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import { CopyDocument } from '@element-plus/icons-vue';
import { callAiModel } from '@/core/services/aiService';
import MessageBubble from '@/shared/components/MessageBubble.vue';
import ChatInput from '@/shared/components/ChatInput.vue';
import EmptyState from '@/shared/components/EmptyState.vue';
import FavorabilityPanel from './components/FavorabilityPanel.vue';
import { analyzeSentiment, calculateGiftEffect } from './utils/favorabilityCalculator';

export default {
  name: 'VirtualLoverMode',
  components: {
    CopyDocument,
    MessageBubble,
    ChatInput,
    EmptyState,
    FavorabilityPanel
  },
  props: {
    config: Object,
    chat: Object
  },
  emits: ['copy-message'],
  data() {
    return {
      messages: [],
      inputMessage: '',
      isLoading: false,
      abortController: null,
      
      // 恋人数据
      loverData: {
        favorability: 50,
        createdAt: new Date().toISOString()
      },
      
      // 礼物系统
      gifts: [
        { id: 1, name: '鲜花', emoji: '🌹', effect: 5 },
        { id: 2, name: '巧克力', emoji: '🍫', effect: 8 },
        { id: 3, name: '首饰', emoji: '💎', effect: 15 },
        { id: 4, name: '情书', emoji: '💌', effect: 10 }
      ],
      showGiftSelector: false,
      
      // 特殊事件
      specialEvents: [],
      
      // 好感度变化动画
      showFavorabilityChange: false,
      favorabilityChange: 0
    };
  },
  methods: {
    startConversation() {
      this.inputMessage = '你好！很高兴认识你~';
      this.$refs.inputRef.focus();
    },
    
    async handleSend() {
      if (!this.inputMessage.trim() || this.isLoading) return;
      
      const userMessage = {
        role: 'user',
        content: this.inputMessage.trim(),
        timestamp: new Date().toISOString()
      };
      
      this.messages.push(userMessage);
      this.inputMessage = '';
      this.isLoading = true;
      
      // 构建系统提示
      const systemPrompt = {
        role: 'system',
        content: `你是一个温柔、善解人意的虚拟恋人。当前好感度：${this.loverData.favorability}。请根据好感度调整回复的亲密程度。`
      };
      
      const assistantMessage = {
        role: 'assistant',
        content: '',
        timestamp: new Date().toISOString()
      };
      
      this.messages.push(assistantMessage);
      
      try {
        await callAiModel({
          provider: this.config.provider,
          apiKey: this.config.apiKey,
          apiUrl: this.config.apiUrl,
          model: this.config.model,
          messages: [systemPrompt, ...this.messages.slice(-10)],  // 只发送最近10条
          temperature: 0.9,  // 更高的创造性
          maxTokens: this.config.maxTokens,
          onChunk: (chunk) => {
            Object.assign(assistantMessage, chunk);
            this.messages = [...this.messages];
          }
        });
        
        // 分析AI回复，更新好感度
        const sentiment = analyzeSentiment(assistantMessage.content);
        this.updateFavorability(sentiment);
        
      } catch (error) {
        console.error('发送消息失败:', error);
        this.messages.pop();  // 移除失败的消息
      } finally {
        this.isLoading = false;
      }
    },
    
    handleCancel() {
      if (this.abortController) {
        this.abortController.abort();
      }
    },
    
    selectGift(gift) {
      const effect = calculateGiftEffect(gift.id);
      this.updateFavorability(effect);
      
      // 添加系统消息
      this.messages.push({
        role: 'system',
        content: `你送出了${gift.emoji} ${gift.name}`,
        timestamp: new Date().toISOString()
      });
      
      this.showGiftSelector = false;
      
      // 触发AI回应
      setTimeout(() => {
        this.inputMessage = `我送你${gift.name}，希望你喜欢~`;
        this.handleSend();
      }, 500);
    },
    
    updateFavorability(change) {
      this.favorabilityChange = change;
      this.loverData.favorability = Math.max(0, Math.min(100, this.loverData.favorability + change));
      
      // 显示变化动画
      this.showFavorabilityChange = true;
      setTimeout(() => {
        this.showFavorabilityChange = false;
      }, 2000);
      
      // 检查是否触发特殊事件
      this.checkSpecialEvents();
    },
    
    checkSpecialEvents() {
      // 好感度达到里程碑
      if (this.loverData.favorability === 70 && !this.hasEvent('first_date')) {
        this.specialEvents.push({
          id: 'first_date',
          message: '💕 好感度达到70！可以邀请TA约会了~'
        });
      }
      
      if (this.loverData.favorability === 90 && !this.hasEvent('confession')) {
        this.specialEvents.push({
          id: 'confession',
          message: '💖 好感度达到90！也许是时候表白了？'
        });
      }
    },
    
    hasEvent(eventId) {
      return this.specialEvents.some(e => e.id === eventId);
    }
  }
};
</script>

<style scoped>
.favorability-change-toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 1rem 2rem;
  border-radius: 0.5rem;
  font-size: 1.5rem;
  font-weight: bold;
  z-index: 9999;
}

.fade-enter-active, .fade-leave-active {
  transition: opacity 0.5s;
}

.fade-enter-from, .fade-leave-to {
  opacity: 0;
}
</style>
```

#### 5. 编写插件配置

```javascript
// src/modes/VirtualLoverMode/plugin.js
import VirtualLoverMode from './index.vue';

export default {
  id: 'virtual-lover',
  name: '虚拟恋人',
  description: '与AI建立温馨的虚拟恋爱关系，体验独特的情感互动',
  icon: 'ChatDotRound',
  version: '1.0.0',
  author: 'tobenot',
  component: VirtualLoverMode,
  config: {
    supportFavorability: true,
    supportGifts: true,
    supportSpecialEvents: true
  }
};
```

#### 6. 注册插件

```javascript
// src/modes/index.js
import VirtualLoverMode from './VirtualLoverMode/plugin';

export function registerAllModes() {
  pluginSystem.register(StandardChatMode);
  pluginSystem.register(VirtualLoverMode);  // ← 添加这行
}
```

完成！现在你可以在模式选择器中看到并使用"虚拟恋人"模式了。

## 示例2：骰子工具

### 功能描述

- 支持多种骰子规则（D20、3D6等）
- 自动计算结果
- 可插入到对话中

### 实现步骤

#### 1. 创建工具组件

```vue
<!-- src/tools/DiceRollerTool/index.vue -->
<template>
  <div class="dice-roller-tool">
    <el-button 
      class="tool-button"
      @click="visible = true"
    >
      <el-icon><Trophy /></el-icon>
      <span>骰子</span>
    </el-button>
    
    <el-dialog v-model="visible" title="掷骰子" width="400px">
      <div class="dice-config">
        <el-form :model="form" label-width="80px">
          <el-form-item label="骰子类型">
            <el-select v-model="form.diceType" class="w-full">
              <el-option label="D4 (4面骰)" value="D4" />
              <el-option label="D6 (6面骰)" value="D6" />
              <el-option label="D8 (8面骰)" value="D8" />
              <el-option label="D10 (10面骰)" value="D10" />
              <el-option label="D12 (12面骰)" value="D12" />
              <el-option label="D20 (20面骰)" value="D20" />
              <el-option label="D100 (百面骰)" value="D100" />
            </el-select>
          </el-form-item>
          
          <el-form-item label="数量">
            <el-input-number v-model="form.count" :min="1" :max="10" class="w-full" />
          </el-form-item>
          
          <el-form-item label="修正值">
            <el-input-number v-model="form.modifier" :min="-10" :max="10" class="w-full" />
          </el-form-item>
        </el-form>
        
        <!-- 结果展示 -->
        <div v-if="result" class="result-display mt-4 p-4 bg-gray-50 rounded">
          <div class="text-lg font-bold text-center mb-2">
            {{ form.count }}{{ form.diceType }} {{ form.modifier >= 0 ? '+' : '' }}{{ form.modifier }}
          </div>
          <div class="dice-results flex justify-center gap-2 mb-2">
            <span 
              v-for="(roll, i) in result.rolls" 
              :key="i"
              class="dice-value px-3 py-1 bg-blue-500 text-white rounded font-bold"
            >
              {{ roll }}
            </span>
          </div>
          <div class="text-2xl font-bold text-center text-blue-600">
            总计: {{ result.total }}
          </div>
        </div>
      </div>
      
      <template #footer>
        <el-button @click="visible = false">取消</el-button>
        <el-button type="primary" @click="rollDice">投掷</el-button>
        <el-button v-if="result" type="success" @click="insertResult">插入结果</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script>
import { Trophy } from '@element-plus/icons-vue';

export default {
  name: 'DiceRollerTool',
  components: { Trophy },
  emits: ['insert-text'],
  data() {
    return {
      visible: false,
      form: {
        diceType: 'D20',
        count: 1,
        modifier: 0
      },
      result: null
    };
  },
  methods: {
    rollDice() {
      const max = parseInt(this.form.diceType.substring(1));
      const rolls = [];
      
      for (let i = 0; i < this.form.count; i++) {
        rolls.push(Math.floor(Math.random() * max) + 1);
      }
      
      const sum = rolls.reduce((a, b) => a + b, 0);
      const total = sum + this.form.modifier;
      
      this.result = {
        rolls,
        sum,
        total
      };
    },
    
    insertResult() {
      const text = `[骰子: ${this.form.count}${this.form.diceType}${this.form.modifier >= 0 ? '+' : ''}${this.form.modifier} = ${this.result.total}]`;
      this.$emit('insert-text', text);
      this.visible = false;
      this.result = null;
    }
  }
};
</script>

<style scoped>
.tool-button {
  display: flex;
  align-items: center;
  gap: 4px;
}

.dice-value {
  animation: roll 0.5s ease-out;
}

@keyframes roll {
  0% { transform: rotateX(0deg); }
  100% { transform: rotateX(360deg); }
}
</style>
```

#### 2. 编写工具配置

```javascript
// src/tools/DiceRollerTool/tool.js
import DiceRollerTool from './index.vue';

export default {
  id: 'dice-roller',
  name: '骰子',
  description: '掷骰子进行随机检定，支持多种骰子规则',
  icon: 'Trophy',
  version: '1.0.0',
  component: DiceRollerTool,
  compatibleModes: ['standard-chat', 'game-mode', 'virtual-lover'],
  handler: (context, result) => {
    return result;  // 返回要插入的文本
  }
};
```

#### 3. 注册工具

```javascript
// src/tools/index.js
import DiceRollerTool from './DiceRollerTool/tool';

export function registerAllTools() {
  toolRegistry.register(ScriptSelectorTool);
  toolRegistry.register(DiceRollerTool);  // ← 添加这行
}
```

#### 4. 在模式中使用工具

在任何模式的输入框工具栏中集成：

```vue
<ChatInput
  v-model="inputMessage"
  @send="handleSend"
>
  <template #toolbar>
    <div class="tools flex gap-2">
      <!-- 动态加载兼容的工具 -->
      <component
        v-for="tool in compatibleTools"
        :key="tool.id"
        :is="tool.component"
        @insert-text="handleToolInsert"
      />
    </div>
  </template>
</ChatInput>

<script>
import { getToolsForMode } from '@/tools';

export default {
  computed: {
    compatibleTools() {
      return getToolsForMode(this.$options.name);
    }
  },
  methods: {
    handleToolInsert(text) {
      this.inputMessage += text;
    }
  }
};
</script>
```

## 总结

通过这些示例，你可以看到：

1. **模式插件**提供完整的功能体验（如虚拟恋人模式）
2. **工具插件**提供可复用的小功能（如骰子工具）
3. **共享组件**在不同插件间复用（MessageBubble、ChatInput等）
4. **核心服务**统一处理底层逻辑（AI调用）

这种架构让开发新功能变得简单、快速、可维护！

