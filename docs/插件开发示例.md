# 插件开发示例

本文档通过具体示例，展示如何开发新的模式插件和工具插件。

## 示例1：骰子工具

### 功能描述

- 支持多种骰子规则（D20、3D6等）
- 自动计算结果
- 可插入到对话中

### 实现步骤

#### 1. 创建工具组件

```vue
<!-- src/tools/DiceRollerTool/index.vue -->
<template>
  <div class="dice-roller-tool">
    <el-button 
      class="tool-button"
      @click="visible = true"
    >
      <el-icon><Trophy /></el-icon>
      <span>骰子</span>
    </el-button>
    
    <el-dialog v-model="visible" title="掷骰子" width="400px">
      <div class="dice-config">
        <el-form :model="form" label-width="80px">
          <el-form-item label="骰子类型">
            <el-select v-model="form.diceType" class="w-full">
              <el-option label="D4 (4面骰)" value="D4" />
              <el-option label="D6 (6面骰)" value="D6" />
              <el-option label="D8 (8面骰)" value="D8" />
              <el-option label="D10 (10面骰)" value="D10" />
              <el-option label="D12 (12面骰)" value="D12" />
              <el-option label="D20 (20面骰)" value="D20" />
              <el-option label="D100 (百面骰)" value="D100" />
            </el-select>
          </el-form-item>
          
          <el-form-item label="数量">
            <el-input-number v-model="form.count" :min="1" :max="10" class="w-full" />
          </el-form-item>
          
          <el-form-item label="修正值">
            <el-input-number v-model="form.modifier" :min="-10" :max="10" class="w-full" />
          </el-form-item>
        </el-form>
        
        <!-- 结果展示 -->
        <div v-if="result" class="result-display mt-4 p-4 bg-gray-50 rounded">
          <div class="text-lg font-bold text-center mb-2">
            {{ form.count }}{{ form.diceType }} {{ form.modifier >= 0 ? '+' : '' }}{{ form.modifier }}
          </div>
          <div class="dice-results flex justify-center gap-2 mb-2">
            <span 
              v-for="(roll, i) in result.rolls" 
              :key="i"
              class="dice-value px-3 py-1 bg-blue-500 text-white rounded font-bold"
            >
              {{ roll }}
            </span>
          </div>
          <div class="text-2xl font-bold text-center text-blue-600">
            总计: {{ result.total }}
          </div>
        </div>
      </div>
      
      <template #footer>
        <el-button @click="visible = false">取消</el-button>
        <el-button type="primary" @click="rollDice">投掷</el-button>
        <el-button v-if="result" type="success" @click="insertResult">插入结果</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script>
import { Trophy } from '@element-plus/icons-vue';

export default {
  name: 'DiceRollerTool',
  components: { Trophy },
  emits: ['insert-text'],
  data() {
    return {
      visible: false,
      form: {
        diceType: 'D20',
        count: 1,
        modifier: 0
      },
      result: null
    };
  },
  methods: {
    rollDice() {
      const max = parseInt(this.form.diceType.substring(1));
      const rolls = [];
      
      for (let i = 0; i < this.form.count; i++) {
        rolls.push(Math.floor(Math.random() * max) + 1);
      }
      
      const sum = rolls.reduce((a, b) => a + b, 0);
      const total = sum + this.form.modifier;
      
      this.result = {
        rolls,
        sum,
        total
      };
    },
    
    insertResult() {
      const text = `[骰子: ${this.form.count}${this.form.diceType}${this.form.modifier >= 0 ? '+' : ''}${this.form.modifier} = ${this.result.total}]`;
      this.$emit('insert-text', text);
      this.visible = false;
      this.result = null;
    }
  }
};
</script>

<style scoped>
.tool-button {
  display: flex;
  align-items: center;
  gap: 4px;
}

.dice-value {
  animation: roll 0.5s ease-out;
}

@keyframes roll {
  0% { transform: rotateX(0deg); }
  100% { transform: rotateX(360deg); }
}
</style>
```

#### 2. 编写工具配置

```javascript
// src/tools/DiceRollerTool/tool.js
import DiceRollerTool from './index.vue';

export default {
  id: 'dice-roller',
  name: '骰子',
  description: '掷骰子进行随机检定，支持多种骰子规则',
  icon: 'Trophy',
  version: '1.0.0',
  component: DiceRollerTool,
  compatibleModes: ['standard-chat', 'game-mode', 'virtual-lover'],
  handler: (context, result) => {
    return result;  // 返回要插入的文本
  }
};
```

#### 3. 注册工具

```javascript
// src/tools/index.js
import DiceRollerTool from './DiceRollerTool/tool';

export function registerAllTools() {
  toolRegistry.register(ScriptSelectorTool);
  toolRegistry.register(DiceRollerTool);  // ← 添加这行
}
```

#### 4. 在模式中使用工具

在任何模式的输入框工具栏中集成：

```vue
<ChatInput
  v-model="inputMessage"
  @send="handleSend"
>
  <template #toolbar>
    <div class="tools flex gap-2">
      <!-- 动态加载兼容的工具 -->
      <component
        v-for="tool in compatibleTools"
        :key="tool.id"
        :is="tool.component"
        @insert-text="handleToolInsert"
      />
    </div>
  </template>
</ChatInput>

<script>
import { getToolsForMode } from '@/tools';

export default {
  computed: {
    compatibleTools() {
      return getToolsForMode(this.$options.name);
    }
  },
  methods: {
    handleToolInsert(text) {
      this.inputMessage += text;
    }
  }
};
</script>
```

## 总结

通过这些示例，你可以看到：

1. **模式插件**提供完整的功能体验
2. **工具插件**提供可复用的小功能（如骰子工具）
3. **共享组件**在不同插件间复用（MessageBubble、ChatInput等）
4. **核心服务**统一处理底层逻辑（AI调用）

这种架构让开发新功能变得简单、快速、可维护！

