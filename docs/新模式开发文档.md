å¤ªå¯¹äº†ï¼ä½ çš„ç†è§£éå¸¸å‡†ç¡®ï¼ğŸ‘

è¿™æ­£æ˜¯å¾®å†…æ ¸æ¶æ„çš„ç²¾é«“æ‰€åœ¨ï¼š

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### ç»Ÿä¸€çš„æ•°æ®ç»“æ„

```javascript
// æ‰€æœ‰æ¨¡å¼å…±äº«åŒä¸€ä¸ªå¯¹è¯æ•°æ®ç»“æ„
{
  id: timestamp,
  title: 'å¯¹è¯æ ‡é¢˜',
  messages: [
    { role: 'user', content: '...' },
    { role: 'assistant', content: '...'}
  ],
  mode: 'standard-chat' // æ ‡è¯†åˆ›å»ºæ—¶ä½¿ç”¨çš„æ¨¡å¼
}
```

### æ¨¡å¼çš„å·®å¼‚åŒ–

ä¸åŒæ¨¡å¼ä¸»è¦åœ¨**ä¸‰ä¸ªå±‚é¢**æœ‰åŒºåˆ«ï¼š

#### 1. **UIå±•ç¤ºå±‚** - å®Œå…¨ä¸åŒ
```
æ ‡å‡†å¯¹è¯ï¼šç®€å•çš„æ°”æ³¡å¯¹è¯
è™šæ‹Ÿæ‹äººï¼šæ°”æ³¡ + ä¾§è¾¹å¥½æ„Ÿåº¦é¢æ¿ + çŠ¶æ€æ˜¾ç¤º
æ¸¸æˆæ¨¡å¼ï¼šæ°”æ³¡ + è§’è‰²å±æ€§é¢æ¿ + éª°å­ç»“æœå¯è§†åŒ–
```

#### 2. **AIè¿”å›æ ¼å¼** - contentä¸­å¯èƒ½åŒ…å«ç»“æ„åŒ–æ•°æ®

contentçš„å†…å®¹

```javascript
// æ ‡å‡†å¯¹è¯
"è¿™æ˜¯å›å¤æ–‡æœ¬"

// è™šæ‹Ÿæ‹äººï¼ˆå¯èƒ½è¿”å›JSONï¼‰
"```json
{ 
  content: "ä»Šå¤©å¤©æ°”çœŸå¥½å‘¢~",
  favorability_change: +5,
  emotion: "happy",
  special_event: null
}
```"

// æ¸¸æˆæ¨¡å¼
"```json
{
  content: "ä½ æˆåŠŸå‘½ä¸­äº†å“¥å¸ƒæ—ï¼",
  dice_result: 18,
  damage: 15,
  enemy_hp: 35,
  loot: ["é‡‘å¸x10"]
}
```"
```

#### 3. **æ•°æ®è§£æå’Œå¤„ç†** - æ’ä»¶å†…éƒ¨å¤„ç†
```javascript
// è™šæ‹Ÿæ‹äººæ¨¡å¼è§£æ
onChunk: (chunk) => {
  try {
    const data = JSON.parse(chunk.content);
    // æå–å¥½æ„Ÿåº¦å˜åŒ–
    this.loverData.favorability += data.favorability_change;
    // æ˜¾ç¤ºæ–‡æœ¬
    assistantMessage.content = data.content;
  } catch {
    // é™çº§ä¸ºæ™®é€šæ–‡æœ¬
    assistantMessage.content = chunk.content;
  }
}
```

## âœ¨ è¿™ä¸ªè®¾è®¡çš„å·¨å¤§ä¼˜åŠ¿

### 1. **ç»Ÿä¸€çš„å­˜å‚¨å’Œç®¡ç†**
```javascript
// AppCore.vue ä¸­åªæœ‰ä¸€ä¸ª chatHistory
chatHistory: [
  { id: 1, mode: 'standard-chat', messages: [...] },
  { id: 2, mode: 'virtual-lover', messages: [...] },
  { id: 3, mode: 'game-mode', messages: [...] }
]
```

### 2. **ç»Ÿä¸€çš„å¯¼å…¥å¯¼å‡º**
```javascript
// ä¸€å¥—ä»£ç æå®šæ‰€æœ‰æ¨¡å¼
exportChatArchive() {
  const jsonData = JSON.stringify(this.chatHistory);
  // æ‰€æœ‰æ¨¡å¼çš„å¯¹è¯éƒ½èƒ½å¯¼å‡º
}

importChatArchive(data) {
  this.chatHistory = JSON.parse(data);
  // æ‰€æœ‰æ¨¡å¼çš„å¯¹è¯éƒ½èƒ½å¯¼å…¥
}
```

### 3. **è·¨æ¨¡å¼æŸ¥çœ‹ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰**
```javascript
// ç†è®ºä¸Šå¯ä»¥ç”¨ä¸åŒæ¨¡å¼æŸ¥çœ‹åŒä¸€å¯¹è¯
// æ¯”å¦‚ç”¨æ ‡å‡†æ¨¡å¼æŸ¥çœ‹æ¸¸æˆæ¨¡å¼çš„å¯¹è¯è®°å½•
switchChat(chatId) {
  const chat = this.chatHistory.find(c => c.id === chatId);
  // chat.mode è®°å½•äº†åŸå§‹æ¨¡å¼ï¼Œä½†å¯ä»¥ç”¨ä»»ä½•æ¨¡å¼æ‰“å¼€
}
```

### 4. **å…ƒæ•°æ®æ‰©å±•æ€§**
```javascript
// messages å¯ä»¥å­˜å‚¨ä»»ä½•é¢å¤–ä¿¡æ¯
{
  role: 'assistant',
  content: 'æ˜¾ç¤ºç»™ç”¨æˆ·çš„æ–‡æœ¬',
  reasoning_content: 'æ€è€ƒè¿‡ç¨‹',
  metadata: {
    // ä»»ä½•æ¨¡å¼ç‰¹å®šçš„æ•°æ®
    favorability: 60,
    gameState: {...},
    images: [...],
    voice: 'url'
  }
}
```

## ğŸ¨ å®é™…å®ç°ç¤ºä¾‹

### è™šæ‹Ÿæ‹äººæ¨¡å¼
```vue
<!-- modes/VirtualLoverMode/index.vue -->
<template>
  <div class="virtual-lover-mode">
    <!-- å·¦ä¾§ï¼šä½¿ç”¨å…±äº«çš„MessageBubbleæ˜¾ç¤ºå¯¹è¯ -->
    <div class="chat-area">
      <MessageBubble 
        v-for="msg in messages" 
        :content="extractDisplayText(msg)"
      />
    </div>
    
    <!-- å³ä¾§ï¼šæ¨¡å¼ç‰¹æœ‰çš„çŠ¶æ€é¢æ¿ -->
    <div class="status-panel">
      <FavorabilityPanel :value="currentFavorability" />
    </div>
  </div>
</template>

<script>
export default {
  methods: {
    extractDisplayText(msg) {
      // å¦‚æœæ˜¯JSONæ ¼å¼ï¼Œæå–textå­—æ®µ
      try {
        const data = JSON.parse(msg.content);
        return data.text || data.content;
      } catch {
        return msg.content; // é™çº§ä¸ºæ™®é€šæ–‡æœ¬
      }
    },
    
    async handleSend() {
      // å‘é€æ¶ˆæ¯ï¼ˆå’Œæ ‡å‡†æ¨¡å¼ä¸€æ ·ï¼‰
      const userMsg = { role: 'user', content: this.inputMessage };
      this.chat.messages.push(userMsg);
      
      // è°ƒç”¨AIï¼ˆå¯èƒ½è¿”å›JSONï¼‰
      await callAiModel({
        ...this.config,
        messages: [
          { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªæ¸©æŸ”çš„è™šæ‹Ÿæ‹äººï¼Œè¯·ä»¥JSONæ ¼å¼è¿”å›ï¼š{text, favorability_change, emotion}' },
          ...this.chat.messages
        ],
        onChunk: (chunk) => {
          try {
            // å°è¯•è§£æJSON
            const data = JSON.parse(chunk.content);
            
            // æ›´æ–°å¥½æ„Ÿåº¦
            if (data.favorability_change) {
              this.loverData.favorability += data.favorability_change;
            }
            
            // æ˜¾ç¤ºæ–‡æœ¬
            assistantMessage.content = data.text;
            
            // å­˜å‚¨å®Œæ•´æ•°æ®ï¼ˆç”¨äºåç»­åˆ†æï¼‰
            assistantMessage.metadata = {
              favorability_change: data.favorability_change,
              emotion: data.emotion
            };
          } catch {
            // å¦‚æœä¸æ˜¯JSONï¼Œå½“åšæ™®é€šæ–‡æœ¬å¤„ç†
            assistantMessage.content = chunk.content;
          }
        }
      });
    }
  }
}
</script>
```

## ğŸ”„ æ•°æ®æµç¨‹å›¾

```
ç”¨æˆ·è¾“å…¥
  â†“
StandardChatMode/VirtualLoverMode/GameMode
  â†“
è°ƒç”¨æ ¸å¿ƒAIæœåŠ¡ï¼ˆå¸¦æ¨¡å¼ç‰¹å®šçš„system promptï¼‰
  â†“
AIè¿”å›ï¼ˆå¯èƒ½æ˜¯çº¯æ–‡æœ¬æˆ–JSONï¼‰
  â†“
æ’ä»¶è§£æå¹¶æå–ï¼š
  - æ˜¾ç¤ºæ–‡æœ¬ â†’ content
  - ç‰¹å®šæ•°æ® â†’ metadata
  â†“
ä¿å­˜åˆ° chat.messagesï¼ˆç»Ÿä¸€ç»“æ„ï¼‰
  â†“
è§¦å‘ update-chat äº‹ä»¶
  â†“
AppCore ä¿å­˜åˆ° chatHistory
  â†“
è‡ªåŠ¨æŒä¹…åŒ–åˆ° localStorage
```

## ğŸ¯ æ¨èçš„æœ€ä½³å®è·µ

### 1. **ç»Ÿä¸€ä½†çµæ´»çš„æ¶ˆæ¯ç»“æ„**
```javascript
{
  role: 'assistant',
  content: '```json{...}```',
  reasoning_content: 'æ€è€ƒè¿‡ç¨‹ï¼ˆå¯é€‰ï¼‰',
  timestamp: '2025-10-06T12:00:00Z'
}
```

### 2. **ä¼˜é›…çš„é™çº§ç­–ç•¥**
```javascript
// AIå¦‚æœè¿”å›æ™®é€šæ–‡æœ¬ï¼Œæ ‡å‡†æ¨¡å¼æ­£å¸¸æ˜¾ç¤º
// AIå¦‚æœè¿”å›JSONï¼Œè™šæ‹Ÿæ‹äººæ¨¡å¼è§£æé¢å¤–ä¿¡æ¯

// è¿™æ ·å³ä½¿AIæ²¡æœ‰è¿”å›é¢„æœŸæ ¼å¼ï¼Œä¹Ÿä¸ä¼šå´©æºƒ
```

### 3. **æ¨¡å¼æ ‡è¯†å’Œå…¼å®¹æ€§**
```javascript
{
  id: 123,
  mode: 'virtual-lover', // åˆ›å»ºæ—¶çš„æ¨¡å¼
  title: 'ç”œèœœå¯¹è¯',
  messages: [...],
  metadata: {
    // æ¨¡å¼ç‰¹å®šçš„å…¨å±€æ•°æ®
    totalFavorability: 85,
    relationship: 'intimate'
  }
}
```

## ğŸŠ æ€»ç»“

ä½ çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼è¿™ä¸ªæ¶æ„è®¾è®¡çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼š

1. **æ•°æ®å±‚ç»Ÿä¸€** - æ‰€æœ‰æ¨¡å¼å…±äº« messages æ•°ç»„
2. **ä¸šåŠ¡å±‚å·®å¼‚** - ä¸åŒæ¨¡å¼æœ‰ä¸åŒçš„UIå’Œæ•°æ®å¤„ç†é€»è¾‘
3. **AIå±‚çµæ´»** - å¯ä»¥è®©AIè¿”å›çº¯æ–‡æœ¬æˆ–JSON
4. **å­˜å‚¨å±‚ç®€å•** - ç»Ÿä¸€å¯¼å…¥å¯¼å‡ºï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†

è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ï¼š
- âœ… **å¼€å‘æ•ˆç‡é«˜** - ä¸ç”¨ä¸ºæ¯ä¸ªæ¨¡å¼é‡å¤å®ç°å­˜å‚¨é€»è¾‘
- âœ… **æ‰©å±•æ€§å¼º** - æ·»åŠ æ–°æ¨¡å¼åªéœ€å…³æ³¨UIå’Œä¸šåŠ¡é€»è¾‘
- âœ… **æ•°æ®å…¼å®¹** - æ‰€æœ‰æ¨¡å¼çš„å¯¹è¯æ•°æ®å¯ä»¥äº’ç›¸è®¿é—®
- âœ… **ç»´æŠ¤ç®€å•** - ç»Ÿä¸€çš„æ•°æ®ç»“æ„ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™ä¸ªæ¶æ„èƒ½å¤Ÿæ”¯æŒæ— é™æ‰©å±•çš„åŸå› ï¼ğŸš€