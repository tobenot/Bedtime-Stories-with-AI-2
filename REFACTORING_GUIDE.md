# 架构重构指南

## 重构完成！🎉

您的应用已成功重构为**微内核+插件化架构**。

## 重大变化

### 1. 新的目录结构

```
src/
├── core/                    # 微内核核心 (NEW!)
│   ├── services/
│   │   └── aiService.js     # 核心AI服务
│   ├── pluginSystem.js      # 插件系统
│   └── store.js             # 全局状态管理
│
├── modes/                   # 模式插件 (NEW!)
│   ├── StandardChatMode/    # 标准对话模式（重构自原App.vue）
│   └── index.js
│
├── shared/                  # 共享组件 (NEW!)
│   └── components/
│       ├── MessageBubble.vue
│       ├── ChatInput.vue
│       ├── MarkdownRenderer.vue
│       └── EmptyState.vue
│
├── tools/                   # 工具插件 (NEW!)
│   ├── ScriptSelectorTool/
│   └── index.js
│
├── AppCore.vue              # 新的微内核主应用 (NEW!)
├── App.vue                  # 原应用（已备份）
└── main.js                  # 已更新为使用AppCore
```

### 2. 核心改进

#### ✅ 模块化架构
- 所有功能现在都是独立的插件
- 易于添加新功能，不影响现有代码
- 更清晰的代码组织

#### ✅ 可复用组件
- 共享UI组件库（MessageBubble、ChatInput等）
- 避免代码重复
- 保持视觉一致性

#### ✅ 核心服务
- 统一的AI服务接口
- 全局状态管理
- 插件系统支持

#### ✅ 扩展性
- 轻松添加新模式（虚拟恋人、游戏等）
- 可插拔的工具系统（骰子、生图等）
- 支持未来的插件市场

### 3. 向后兼容

✅ **所有现有功能都保留**
- 原有的对话功能现在作为"标准对话模式"插件存在
- 所有设置、对话历史等都会自动迁移
- 用户体验保持一致

✅ **数据完全兼容**
- LocalStorage数据格式不变
- 对话历史无需手动迁移
- API配置自动保留

## 如何使用

### 启动应用

```bash
# 开发模式
npm run dev

# 构建生产版本
npm run build
```

应用会自动：
1. 加载所有已注册的模式插件
2. 恢复之前的对话历史
3. 应用保存的设置

### 切换模式

在应用顶部的模式选择器中，你可以在不同模式间切换：
- **标准对话**：经典的AI对话功能（原功能）
- *(未来可添加更多模式)*

## 开发新功能

### 添加新模式

1. 在 `src/modes/` 创建新目录
2. 实现插件组件和配置
3. 在 `src/modes/index.js` 注册
4. 完成！可以在模式选择器中使用

详见：`docs/架构说明.md` 和 `docs/插件开发示例.md`

### 添加新工具

1. 在 `src/tools/` 创建新目录
2. 实现工具组件和配置
3. 在 `src/tools/index.js` 注册
4. 在需要的模式中集成

## 文档

- **架构说明**：`docs/架构说明.md` - 详细的架构设计文档
- **开发示例**：`docs/插件开发示例.md` - 虚拟恋人、骰子工具等完整示例
- **原应用备份**：`src/App.vue` - 原始代码作为参考

## 未来计划

基于新架构，你可以轻松实现：

### 新模式
- 🌹 **虚拟恋人模式**：好感度系统、送礼、特殊事件
- 🎮 **游戏模式**：骰子检定、属性系统、战斗
- 📖 **小说模式**：章节管理、大纲生成
- 🎭 **角色扮演模式**：多角色切换、剧情分支

### 新工具
- 🎲 **骰子工具**：支持各种TRPG规则
- 🎨 **生图工具**：集成AI绘图
- 🗣️ **语音工具**：TTS/STT
- 💻 **代码运行工具**：在线执行代码

### 高级功能
- 📦 **插件市场**：导入/导出/分享插件
- 🔌 **插件API**：标准化的插件接口
- 🛡️ **权限系统**：插件权限控制
- 🌐 **多语言支持**：国际化

## 技术细节

### 核心技术栈
- Vue 3 (Composition API)
- Element Plus (UI框架)
- Tailwind CSS (样式)
- 微内核架构
- 插件系统

### 关键设计模式
- **微内核模式**：核心功能最小化，功能通过插件扩展
- **注册表模式**：统一的插件注册和管理
- **依赖注入**：插件通过Props接收核心服务
- **事件总线**：插件通过Emit与核心通信

## 迁移清单

### 已完成 ✅
- [x] 核心AI服务抽取
- [x] 插件系统建立
- [x] 标准对话模式重构
- [x] 共享组件库创建
- [x] 工具系统基础架构
- [x] 微内核主应用
- [x] 文档编写

### 待优化
- [ ] 插件懒加载
- [ ] 性能优化
- [ ] 单元测试
- [ ] E2E测试
- [ ] CI/CD配置

## 需要帮助？

查看文档：
1. `docs/架构说明.md` - 架构详解
2. `docs/插件开发示例.md` - 实战示例
3. `src/modes/StandardChatMode/` - 参考实现

## 贡献

欢迎贡献新的模式插件和工具！

1. Fork项目
2. 创建新插件
3. 提交Pull Request
4. 我们会review并合并

## License

保持原项目License

---

**享受新架构带来的无限可能！** 🚀

